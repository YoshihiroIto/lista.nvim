Describe Matcher.And
  Before all
    let Guard = vital#vital#import('Vim.Guard')
    let candidates = []
    let candidates += map(range(1, 1000), '''A'' . string(v:val)')
    let candidates += map(range(1, 1000), '''a'' . string(v:val)')
    let indices = range(len(candidates))
  End

  Before
    let Matcher = vital#lista#import('Matcher.And')
    let guard = Guard.store(['&ignorecase'])
  End

  After
    call guard.restore()
  End

  Describe .filter()
    It filters candidates (ignorecase)
      set ignorecase
      let available_indices = Matcher.filter(
            \ 'a 10 5', indices, candidates
            \)
      let available_candidates = map(
            \ copy(available_indices),
            \ 'candidates[v:val]'
            \)
      Assert Equals(available_candidates, [
            \ 'A105',
            \ 'A510',
            \ 'a105',
            \ 'a510',
            \])
    End

    It filters candidates (noignorecase)
      set noignorecase
      let available_indices = Matcher.filter(
            \ 'a 10 5', indices, candidates
            \)
      let available_candidates = map(
            \ copy(available_indices),
            \ 'candidates[v:val]'
            \)
      Assert Equals(available_candidates, [
            \ 'a105',
            \ 'a510',
            \])
    End
  End

  if has('lua')
    Describe .filter_lua()
      It filters candidates (ignorecase)
        set ignorecase
        let available_indices = Matcher.filter_lua(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'A105',
              \ 'A510',
              \ 'a105',
              \ 'a510',
              \])
      End

      It filters candidates (noignorecase)
        set noignorecase
        let available_indices = Matcher.filter_lua(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'a105',
              \ 'a510',
              \])
      End
    End
  endif

  if has('python')
    Describe s:filter_python()
      It filters candidates (ignorecase)
        set ignorecase
        let available_indices = Matcher.filter_python(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'A105',
              \ 'A510',
              \ 'a105',
              \ 'a510',
              \])
      End

      It filters candidates (noignorecase)
        set noignorecase
        let available_indices = Matcher.filter_python(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'a105',
              \ 'a510',
              \])
      End
    End
  endif

  if has('python3')
    Describe s:filter_python3()
      It filters candidates (ignorecase)
        set ignorecase
        let available_indices = Matcher.filter_python3(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'A105',
              \ 'A510',
              \ 'a105',
              \ 'a510',
              \])
      End

      It filters candidates (noignorecase)
        set noignorecase
        let available_indices = Matcher.filter_python3(
              \ 'a 10 5', indices, candidates
              \)
        let available_candidates = map(
              \ copy(available_indices),
              \ 'candidates[v:val]'
              \)
        Assert Equals(available_candidates, [
              \ 'a105',
              \ 'a510',
              \])
      End
    End
  endif

  Describe .filter_vim()
    It filters candidates (ignorecase)
      set ignorecase
      let available_indices = Matcher.filter_vim(
            \ 'a 10 5', indices, candidates
            \)
      let available_candidates = map(
            \ copy(available_indices),
            \ 'candidates[v:val]'
            \)
      Assert Equals(available_candidates, [
            \ 'A105',
            \ 'A510',
            \ 'a105',
            \ 'a510',
            \])
    End

    It filters candidates (noignorecase)
      set noignorecase
      let available_indices = Matcher.filter_vim(
            \ 'a 10 5', indices, candidates
            \)
      let available_candidates = map(
            \ copy(available_indices),
            \ 'candidates[v:val]'
            \)
      Assert Equals(available_candidates, [
            \ 'a105',
            \ 'a510',
            \])
    End
  End
End

